%% Based on LIR18650(2200mAh) Li-ion battery
Q0 = 7.92e+3; % Coulombs

%%Charging

% time (h) vs input voltage (V)
V = [0.0060339154021687436, 3.541753341411358;
0.05367785903641881, 3.6682552081731568;
0.08825754546964276, 3.7795892508964766;
0.10565810273033122, 3.8048763385635467;
0.18428352636531936, 3.8300600931228126;
0.31968680227086793, 3.8754011846402716;
0.4595186399394762, 3.9055449283741646;
0.6518473868410206, 3.930536778590364;
0.7960708815913298, 3.9556098191055535;
0.9708883571881093, 3.985694515349272;
1.1718897042089786, 4.030924892822655;
1.3291590038196341, 4.076229079658755;
1.4994741082906364, 4.141764412815766;
1.5868090367263084, 4.177060050067351;
1.665452912701976, 4.2;
2.9905339492314598, 4.2];

% time (h) vs charge (mAh)
C = [0.01081273910422792, 246.81706912034224;
0.07292140774728456, 347.9081839764799;
0.3376674498419298, 617.205663464259;
0.6552593704254979, 928.5485835188765;
0.9596582731600507, 1231.489796169412;
1.3125299841314748, 1576.4887505689296;
1.5905428511679973, 1862.6265484113026;
1.6609548177579863, 1913.061395200079;
1.7223254154724266, 1929.766400551093;
1.8195662603176166, 2047.636327851107;
1.9512750175291844, 2106.337569040385;
2.1224152141020753, 2173.366710540883;
2.3151993406566374, 2215.0185132791266;
2.520955063781629, 2239.756190569914;
2.9103797374927733, 2263.9772182106703;
3.0197803008869153, 2272.108299607593];

% time (h) vs current (mA)
I = [0.027013395987354305, 1099.092172757802;
1.7062723727750237, 1094.3685188146583;
1.7529738107832162, 933.8995977513437;
1.7991585991413774, 714.3604000344435;
1.8766929501925136, 579.1212035476615;
1.9932158980478019, 401.57824166902446;
2.1276739694684665, 274.61774076488746;
2.314682691006606, 155.94823662554018;
2.4847157811865723, 96.3982138683532;
2.6243588008807643, 62.250132237708385;
2.803359452843418, 27.991339967771637;
3, 0];

t = linspace(0,3,1000);
VOLTAGE = interp1(V(:,1),V(:,2),t);
CURRENT = interp1(I(:,1),I(:,2),t);
CAPACITY = interp1(C(:,1),C(:,2),t);

figure;
plot(CAPACITY,VOLTAGE.*CURRENT)
title('Charge(mAh) vs input power needed(mW)')

%%Discharging
% SOC(%) vs voltage(V)  for different discharge rates, where 0.5C corresponds to 2.5hs
DV_0_2C = [0, 4.1567567567567565;
	4.251968503936979, 4.0864864864864865;
	9.291338582677142, 4.037837837837838;
	14.960629921259816, 3.989189189189189;
	20.472440944881868, 3.9405405405405403;
	28.18897637795274, 3.8864864864864863;
	35.11811023622045, 3.843243243243243;
	42.36220472440943, 3.8;
	51.02362204724409, 3.762162162162162;
	59.84251968503936, 3.7297297297297294;
	66.77165354330708, 3.7135135135135133;
	72.91338582677166, 3.7027027027027026;
	81.73228346456692, 3.6648648648648647;
	90.70866141732284, 3.627027027027027;
	92.75590551181102, 3.6108108108108103;
	95.11811023622047, 3.5567567567567564;
	96.53543307086615, 3.497297297297297;
	97.79527559055119, 3.41081081081081;
	99.05511811023622, 3.281081081081081;
	99.5275590551181, 3.172972972972973;
	100, 2.8864864864864863];

DV_0_5C = [0.15748031496060122, 4.129729729729729;
3.6220472440944604, 4.075675675675676;
7.244094488188949, 4.016216216216216;
11.33858267716533, 3.962162162162162;
16.37795275590549, 3.9189189189189184;
21.732283464566905, 3.8756756756756756;
28.34645669291337, 3.8270270270270266;
32.75590551181101, 3.7945945945945945;
39.05511811023621, 3.7567567567567566;
45.35433070866141, 3.724324324324324;
50.70866141732283, 3.7027027027027026;
57.95275590551181, 3.6756756756756754;
65.35433070866141, 3.6486486486486482;
71.81102362204723, 3.627027027027027;
80, 3.6054054054054054;
85.35433070866141, 3.5837837837837836;
89.4488188976378, 3.5567567567567564;
94.80314960629921, 3.4648648648648646;
96.37795275590551, 3.3621621621621616;
98.58267716535433, 3.1945945945945944;
100, 3.005405405405405];

DV_1C = [0, 4.075675675675676;
3.77952755905509, 4;
7.874015748031471, 3.9189189189189184;
10.23622047244092, 3.8864864864864863;
15.275590551181075, 3.8378378378378377;
20.472440944881868, 3.7945945945945945;
27.874015748031482, 3.7351351351351347;
33.2283464566929, 3.7027027027027026;
38.11023622047242, 3.67027027027027;
42.99212598425195, 3.6378378378378375;
50.236220472440934, 3.6054054054054054;
56.37795275590551, 3.5837837837837836;
62.83464566929133, 3.5621621621621617;
68.503937007874, 3.5405405405405403;
74.80314960629921, 3.5189189189189185;
78.89763779527559, 3.497297297297297;
85.66929133858267, 3.4594594594594588;
89.4488188976378, 3.4216216216216213;
92.5984251968504, 3.3621621621621616;
94.48818897637796, 3.297297297297297;
96.22047244094489, 3.1999999999999997;
97.16535433070867, 3.102702702702702;
98.26771653543307, 2.9567567567567563;
98.89763779527559, 2.832432432432432;
99.21259842519684, 2.7459459459459454];

figure;
hold on;
plot(DV_0_2C(:,1),DV_0_2C(:,2));
plot(DV_0_5C(:,1),DV_0_5C(:,2));
plot(DV_1C(:,1),DV_1C(:,2));
legend('0.2 C','0.5 C','1 C')
title('Discharge voltage (V) vs SOC (%)')

L = rand; %inductance (series) (H)

% R0 resistance is given by AR0*I0 + BR0, where I0 is the current across the resistor
AR0 = 1e-4*rand; % ohm/A
BR0 = 1e-4*rand; % ohm

% number of RC rings in series
n = 10;

% Rk resistance is given by ARk*Ik + BRk, where Ik is the current across the k-th resistor
AR = 1e-4*rand(n,1); % ohm/A
BR = 1e-4*rand(n,1); % ohm

% capacitance in the k-th ring
C = rand(n,1); % F

% load resistance
RL = rand; % ohm

% charge of the k-th capacitor
Q = zeros(n,1); % C

% current electric current across the series resistor
I0 = 1.1;%A
% current electric current of each RC ring
I = zeros(n,1);

dt = 0.01; % duração de um slot de tempo (s)

% source voltage (max)
v = 4.2; %(v)

% constant current
v_ = 0;
% current resistance of the series resistor
R0 = AR0.*I0 + BR0;
Q_reg = sum(Q);
V_reg = v_;
I_reg = I0;
while v_ < v
	% current resistance of each RC ring
	RC = AR.*I + BR;
	
	I = (Q./C + dt * I0 ./ C)./(RC + dt./C);
	
	v_ = (RL + R0) * I0 + RC.'*I;
	
	v_ - ((R0+RL+dt*sum(1./(C.*RC+dt)))*I0 + sum(Q./(C.*RC+dt)))
	
	Q = Q + dt*I;
	
	Q_reg = [Q_reg;sum(Q)];
	V_reg = [V_reg;v_];
	I_reg = [I_reg;I0];
end

% constant voltage
while I0 >= 0.02
	% current resistance of the series resistor
	R0 = AR0.*I0 + BR0;

	% current resistance of each RC ring
	RC = AR.*I + BR;
	
	Z = [RL + R0 - L/dt, RC.';
		-(dt./C), diag(RC + dt./C)];
	
	I_ = Z\[v - L/dt*I0; Q./C];
	
	I0 = I_(1);
	I = I_(2:end);
	
	Q = Q + dt * I;
	
	Q_reg = [Q_reg;sum(Q)];
	V_reg = [V_reg;v];
	I_reg = [I_reg;I0];
end

figure;
plot(V_reg);
title('voltage');
figure;
plot(I_reg);
title('current');
figure;
plot(Q_reg);
title('charge');